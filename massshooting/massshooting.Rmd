---
title: "a look at mass shootings"
author: "daniel njoo"
date: "11/14/2017"
output: html_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = T)
```

```{r libs, echo=F}
#libs
library(lubridate)
library(dplyr)
library(ggplot2)
library(reshape2)

```

```{r data, echo=F}
# data
setwd('/Users/danielnjoo/Desktop/data_investigations/massshooting/')
d2013<-read.csv('./MST Data 2013 - 2015.csv')
d2014<-read.csv('./MST Data 2014 - 2015.csv')
d2015<-read.csv('./MST Data 2015 - 2015.csv')
d2016<-read.csv('./Mass Shooting Data 2016 - 2016.csv')
d2017<-read.csv('./Mass Shooting Data 2017 - 2017.csv')
dfull<-rbind(d2013,d2014,d2015,d2016,d2017)
dfull$week <- week(mdy(dfull$date))
dfull$year <- year(mdy(dfull$date))
dfull$week2 <- as.Date(paste(dfull$year, dfull$week, 1, sep="-"), "%Y-%U-%u")
dfull$month <- month(mdy(dfull$date))
dfull$month2 <- as.Date(paste(dfull$year, dfull$month, 1, sep="-"), "%Y-%m-%d")
dfull$dateF <- as.Date(dfull$date, format="%m/%d/%Y")
```

# Intro

In this investigation, I use the 5 years worth of freely available data from [massshootingtracker.org](https://www.massshootingtracker.org/data) (all the observations of which have news sources), and visualize 5 years of incidents. I work with:

- `ownership rate`, an estimate of gun ownership levels taken from [this data graphic](http://www.businessinsider.com/gun-ownership-by-state-2015-7)
- and normalize it for `state populations` to show a clear(er) relationship between state gun ownership levels and the total number of incidents over the period in question

To be completed: 

- investigate whether there is a copycat effect, i.e. an increased % of a shooting in a state after one in the previous week 
- look at cherrypicking in shooting visualizations and try to replicate the graphics
- mental illness / violent video games (by download?)

# Data

An initial look at the data, we have (5 years worth) from 

```{r initial}
#initial
dim(dfull)
names(dfull)

```

The data contains 1890 observations (shootings) and 12 variables for each shooting. 

```{r initial1}
#initial1
dfull %>% arrange(desc(dateF)) %>% select(city, date, killed, wounded) %>% head()

```

The most recent 6 shootings in the data I downloaded are shown above.

# Initial Look

### Number of incidents aggregated by year

```{r initial2, echo=F}
#initial2
dfull %>% 
  group_by(year) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(year, count)) + 
    geom_bar(stat='identity') +
    ggtitle("Number of shootings from year to year (2017, 83% complete)")

```

### Aggregated by month

```{r initial3, echo=F}
#initial3
dfull %>% arrange(dateF) %>% head(1) %>% .[[1]] %>% as.Date(format="%m/%d/%Y") -> first.date
dfull %>% arrange(dateF) %>% tail(1) %>% .[[1]] %>% as.Date(format="%m/%d/%Y") -> last.date
dfull %>% 
  filter(dateF<'2017-11-01') %>% 
  group_by(month2) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(month2, count)) + 
    geom_line() +
    xlab("Date (aggregated by month)") +
    ylab("Number of shootings") + 
    ggtitle("Number of shootings from month to month, Jan2013-Oct2017") +
    scale_x_date(limits=c(first.date, last.date))

```

Visualizing just the sheer number of incidents aggregated by month we notice (i) a certain amount of inherent variability and (ii) a distinctive uptrend, NB we exclude November/December 2017 due to lack of full results

###  The number wounded and killed each month

```{r initial4, echo=F}
#initial4
dfull %>% 
  group_by(month2) %>% 
  summarise(wounded=sum(wounded), killed=sum(killed)) %>% 
  melt(id.var="month2") %>% 
  ggplot(aes(month2, value, fill = variable)) + 
    geom_bar(stat='identity') +
    xlab("Date (aggregated by month)") +
    ylab("Number wounded/killed") + 
    ggtitle("Number wounded/killed from month to month Jan2013-Oct2017")
    
```

### Looking at killed only 

```{r initial5, echo=F}
#initial5
dfull %>% 
  group_by(month2) %>% 
  summarise(killed=sum(killed)) %>% 
  ggplot(aes(month2, killed)) + 
    geom_line() +
    xlab("Date (aggregated by month)") +
    ylab("Number killed") + 
    ggtitle("Number killed from month to month Jan2013-Oct2017")

```

We can isolate the two most distinctive peaks to specific events by looking at individual shootings

### Identifying the most deadly incidents

```{r initial6, echo=F, warning=F}
#initial6
dfull %>% ggplot(aes(as.Date(date, format="%d/%m/%Y"), killed)) + 
  geom_point() + 
  geom_text(data=subset(dfull, as.numeric(killed)>6), aes(as.Date(date, format="%d/%m/%Y"), killed, label = paste(city, year)), nudge_y = 2) +
  xlab("Date") +
  xlab("Date (aggregated by week)") + 
  ylab("Killed (aggregated by week)") +
  ggtitle("Every incident by date")

```

# Adding ownership data

I manually encoded ownership data from [this data graphic](http://www.businessinsider.com/gun-ownership-by-state-2015-7) courtesy of Business Insider, to incorporate up-to-date state-level gun ownership data that is internall consistent. BI took their data from [this paper](http://injuryprevention.bmj.com/content/injuryprev/early/2015/06/09/injuryprev-2015-041586.full.pdf?keytype=ref&ijkey=doj6vx0laFZMsQ2).

```{r ownership, warning=F}
#ownership
ownership_by_state <- c(27.7, 26.6, 20.1, 56.9, 37.5,
                      52.3, 53.8, 31.9, 32.3, 61.7, 
                      34.3, 49.9, 45.1, 47.9, 35.0, 
                      19.8, 32.2, 31.2, 35.7, 36.7, 
                      33.8, 27.1, 57.9, 44.5, 34.7, 
                      26.2, 28.8, 33.8, 42.4, 39.4, 
                      42.8, 48.9, 19.6, 32.5, 31.6, 
                      44.4, 28.7, 29.3, 54.2, 27.1, 
                      10.3, 22.6, 28.8, 14.4, 22.6,
                      5.8, 16.6, 11.3, 5.2, 20.7,
                      25.9
                      )
ownership_states <- c("WA", "OR", "CA", "ID", "NV",
                    "MT", "WY", "UT", "AZ", "AK", 
                    "CO", "NM", "HI", "ND", "SD",
                    "NE", "KS", "OK", "TX", "MN", 
                    "IA", "MO", "AR", "LA", "WI",
                    "IL", "MI", "IN", "KY", "TN", 
                    "MS", "AL", "OH", "FL", "GA",
                    "SC", "NC", "VA", "WV", "PA",
                    "NY", "ME", "VT", "NH", "MA",
                    "RI", "CT", "NJ", "DE", "MD",
                    "DC"
                    )

ownership_and_states <- data.frame(ownership_by_state, ownership_states) 
names(ownership_and_states) <- c("ownership rate", "state")

dfull %>% inner_join(ownership_and_states)-> dfull
dfull %>% arrange(desc(dateF)) %>% select(city, date, killed, wounded, state, `ownership rate`) %>% head()
```

### Total incidents per state mapped with gun ownership levels

```{r ownership2, echo=F}
#ownership2
dfull %>% 
  group_by(state, `ownership rate`) %>% 
  summarise(total=n()) %>% 
  ggplot(aes(state,total, col=as.numeric(`ownership rate`), size=as.numeric(`ownership rate`))) +
    geom_point() +
    theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1), legend.title=element_blank()) + 
    ggtitle("Incidents per state mapped with gun ownership levels")

```

Note in this case color and size both map `ownership level` (yes that's confusing and not good practice!), but using only one aesthetic resulted in an even more confusing graph. It's interesting to note here that no clear pattern emerges, i.e. wouldn't you expect all the lighter-colored, and larger spots/states to have more incidents?... wait don't states differ by population?

Let's normalize for population, using 2016 population data from Wikipedia... (code in Appendix)

```{r ownership3, echo=F}
#ownership3
data(state)
library(rvest)

state_pop <- read_html('https://en.wikipedia.org/wiki/List_of_U.S._states_and_territories_by_population') %>% 
  html_table() %>%
  .[[1]] %>% 
  mutate(pop16=`Population estimate, July 1, 2016[4]`) %>% 
  filter(`State or territory`!='District of Columbia', `State or territory`!='Puerto Rico') %>% 
  select(pop16, `State or territory`) %>% 
  .[1:50,]

for (i in 1:nrow(state_pop)) {
  state_pop[i,3]<-state.abb[match(state_pop[i,2],state.name)]
}

dfull <- dfull %>% 
  inner_join(state_pop, by=c('state'='V3')) 

dfull <- dfull %>% 
  mutate(
    pop16 = as.numeric(gsub(",", "", dfull$pop16)), 
    totalOwners = as.numeric(`ownership rate`) * pop16) 

```

We now have total owner data...

```{r ownership4}
#ownership4
dfull %>% 
  arrange(desc(dateF)) %>% 
  select(city, date, killed, wounded, state, totalOwners) %>% 
  head()
```

... so let's try that previous graph again:

### Total incidents per state mapped with (normalized) gun ownership estimates

```{r ownership5, echo=F}
#ownership5
dfull %>% 
  group_by(state, totalOwners) %>% 
  summarise(total=n()) %>% 
  ggplot(aes(state,total, col=totalOwners, size=totalOwners)) +
    geom_point() +
    theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
    ggtitle("Incidents per state mapped with (normalized) gun ownership estimates")

```

# Appendix
```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```

















